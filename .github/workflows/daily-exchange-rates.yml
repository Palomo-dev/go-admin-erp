name: Actualizar Tasas de Cambio Diarias

on:
  schedule:
    # Ejecutar todos los días laborables a las 7:00 AM UTC (2:00 AM COT)
    - cron: '0 7 * * 1-6'
  workflow_dispatch: # Permite ejecución manual desde GitHub

jobs:
  update-exchange-rates:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: 📊 Actualizar Tasas de Cambio
        run: |
          echo "🚀 Iniciando actualización de tasas de cambio..."
          
          # Llamar a la Edge Function
          response=$(curl -w "%{http_code}" -s -o response.json -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/actualizar-tasas-cambio" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"source": "github-actions", "cron": true}')
          
          echo "📡 HTTP Status: $response"
          
          # Mostrar respuesta para debug
          if [[ -f "response.json" ]]; then
            echo "📄 Respuesta de Edge Function:"
            cat response.json
          fi
          
          # Verificar si fue exitoso
          if [[ "$response" == "200" ]]; then
            echo "✅ Tasas actualizadas correctamente"
          else
            echo "❌ Error en actualización de tasas (HTTP: $response)"
            exit 1
          fi
      
      - name: 📧 Notificar si hay error
        if: failure()
        run: |
          echo "🚨 ALERTA: Falló la actualización automática de tasas de cambio"
          echo "Fecha: $(date)"
          echo "Revisar logs de Supabase Edge Function"

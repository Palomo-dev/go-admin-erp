name: Actualizar Tasas de Cambio Diarias

on:
  schedule:
    # Ejecutar todos los dÃ­as laborables a las 7:00 AM UTC (2:00 AM COT)
    - cron: '0 7 * * 1-6'
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub

jobs:
  update-exchange-rates:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“Š Actualizar Tasas de Cambio
        run: |
          echo "ğŸš€ Iniciando actualizaciÃ³n de tasas de cambio..."
          
          # Llamar a la Edge Function
          response=$(curl -w "%{http_code}" -s -o response.json -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/actualizar-tasas-cambio" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"source": "github-actions", "cron": true}')
          
          echo "ğŸ“¡ HTTP Status: $response"
          
          # Mostrar respuesta para debug
          if [[ -f "response.json" ]]; then
            echo "ğŸ“„ Respuesta de Edge Function:"
            cat response.json
          fi
          
          # Verificar si fue exitoso
          if [[ "$response" == "200" ]]; then
            echo "âœ… Tasas actualizadas correctamente"
          else
            echo "âŒ Error en actualizaciÃ³n de tasas (HTTP: $response)"
            exit 1
          fi
      
      - name: ğŸ“§ Notificar si hay error
        if: failure()
        run: |
          echo "ğŸš¨ ALERTA: FallÃ³ la actualizaciÃ³n automÃ¡tica de tasas de cambio"
          echo "Fecha: $(date)"
          echo "Revisar logs de Supabase Edge Function"
